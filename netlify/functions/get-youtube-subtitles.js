// netlify/functions/get-youtube-subtitles.js
const fetch = require('node-fetch');

// This function uses the official YouTube Data API v3 to get a list of available caption tracks.
// This method is reliable for listing tracks.

exports.handler = async (event, context) => {
    const { videoId } = event.queryStringParameters;
    const apiKey = process.env.YOUTUBE_API_KEY;

    if (!videoId) {
        return {
            statusCode: 400,
            body: JSON.stringify({ error: '遺失影片 ID (videoId) 參數。' }),
        };
    }

    if (!apiKey) {
        return {
            statusCode: 500,
            body: JSON.stringify({ error: '伺服器未設定 YouTube API Key。' }),
        };
    }

    const apiUrl = `https://www.googleapis.com/youtube/v3/captions?part=snippet&videoId=${videoId}&key=${apiKey}`;

    try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (data.error) {
            console.error('YouTube API Error:', data.error.message);
            return {
                statusCode: data.error.code || 500,
                body: JSON.stringify({ error: `YouTube API 錯誤: ${data.error.message}` }),
            };
        }

        if (!data.items || data.items.length === 0) {
            return {
                statusCode: 404,
                body: JSON.stringify({ error: '找不到這部影片的任何字幕軌道。' }),
            };
        }

        // Map the tracks to a format the frontend can use.
        // We will pass the language code to the next function for downloading.
        const availableTracks = data.items.map(item => ({
            name: item.snippet.name || item.snippet.language, // Fallback to lang code if name is empty
            lang: item.snippet.language,
            isAutoGenerated: item.snippet.trackKind === 'ASR', // ASR = Automatic Speech Recognition
        }));

        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json; charset=utf-8',
            },
            body: JSON.stringify(availableTracks),
        };

    } catch (error) {
        console.error('Error fetching data from YouTube API:', error);
        return {
            statusCode: 500,
            body: JSON.stringify({ error: '呼叫 YouTube API 時發生網路錯誤。' }),
        };
    }
};